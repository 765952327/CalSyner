<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>服务配置管理</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="/admin/styles.css">
</head>
<body class="container">
  <div class="layout">
    <svg style="display:none" xmlns="http://www.w3.org/2000/svg">
      <symbol id="i-edit" viewBox="0 0 24 24"><path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25z" fill="currentColor"/><path d="M20.71 7.04a1 1 0 0 0 0-1.41l-2.34-2.34a1 1 0 0 0-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z" fill="currentColor"/></symbol>
      <symbol id="i-save" viewBox="0 0 24 24"><path d="M17 3H5a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V7l-4-4z" stroke="currentColor" stroke-width="2" fill="none"/><path d="M17 3v5H7V3" stroke="currentColor" stroke-width="2"/><rect x="7" y="13" width="10" height="6" stroke="currentColor" stroke-width="2" fill="none"/></symbol>
      <symbol id="i-test" viewBox="0 0 24 24"><path d="M4 4h16v4H4z" stroke="currentColor" stroke-width="2" fill="none"/><path d="M10 8v8a2 2 0 0 0 2 2h6" stroke="currentColor" stroke-width="2"/></symbol>
      <symbol id="i-trash" viewBox="0 0 24 24"><path d="M3 6h18" stroke="currentColor" stroke-width="2"/><path d="M8 6V4h8v2" stroke="currentColor" stroke-width="2"/><rect x="5" y="6" width="14" height="14" rx="2" ry="2" stroke="currentColor" stroke-width="2" fill="none"/></symbol>
    </svg>
    <aside class="sidebar">
      <div class="brand"><span>JiraSync</span></div>
      <nav class="side-nav">
        <a href="/admin/index.html" title="首页"><span class="side-icon"><svg class="icon icon-sm" viewBox="0 0 24 24"><path d="M3 10 L12 3 L21 10 V21 H3 Z" fill="currentColor"/></svg></span><span class="side-label">首页</span></a>
        <a href="/admin/config.html" title="服务配置"><span class="side-icon"><svg class="icon icon-sm" viewBox="0 0 24 24"><path d="M12 2 L19 7 L19 17 L12 22 L5 17 L5 7 Z" fill="currentColor"/></svg></span><span class="side-label">服务配置</span></a>
        <a href="/admin/tasks.html" title="同步任务"><span class="side-icon"><svg class="icon icon-sm" viewBox="0 0 24 24"><rect x="3" y="4" width="18" height="16" rx="2" ry="2" stroke="currentColor" stroke-width="2" fill="none"/><path d="M7 12 L10 15 L17 8" stroke="currentColor" stroke-width="2" fill="none"/></svg></span><span class="side-label">同步任务</span></a>
        <a href="/admin/records.html" title="同步记录"><span class="side-icon"><svg class="icon icon-sm" viewBox="0 0 24 24"><circle cx="12" cy="12" r="9" stroke="currentColor" stroke-width="2" fill="none"/><path d="M12 7 L12 12 L16 14" stroke="currentColor" stroke-width="2"/></svg></span><span class="side-label">同步记录</span></a>
      </nav>
    </aside>
    <main>
  <header class="app"><h1>服务配置</h1><nav class="app"><a href="/admin/create.html">新增配置</a></nav></header>

  <div class="hero">
    <h3 class="title">服务配置</h3>
    <p class="desc">管理各类服务连接与脚本能力，点击卡片查看详细配置。</p>
  </div>
  <h3 id="custom-script" class="section-title">现有配置</h3>
  <div id="scriptHelp" class="card" style="display:none">
    <p>当前显示 <b>CUSTOM</b> 类型的服务。请点击卡片进入详情页面进行脚本管理。</p>
    <p>如需新增，请在下方“新增配置”选择类型为 <b>CUSTOM</b> 并保存。</p>
  </div>
  <div id="svcList" class="grid cols-1"></div>

  
  <div id="toast" class="toast"></div>
    </main>
  </div>

  <script>
    const api = '/api/config/services';
    (function(){
      const p=location.pathname;
      const canon = (p.endsWith('/admin/logs.html')||p.endsWith('/admin/details.html'))? '/admin/records.html' : p;
      document.querySelectorAll('.side-nav a').forEach(a=>{
        const href=a.getAttribute('href');
        if(href===canon) a.classList.add('active');
        if(location.hash==='#custom-script' && href==='/admin/config.html#custom-script') a.classList.add('active');
      });
    })();
    const listEl = document.querySelector('#svcList');
    function load(){
      fetch(api).then(r=>r.json()).then(list=>{
        listEl.innerHTML='';
        list.forEach(x=>{
          const card=document.createElement('div');
          card.className='card svc';
          card.setAttribute('data-id', String(x.id));
          card.setAttribute('data-type', x.serviceType||'');
          const statusClass = (x.connectionStatus==='OK')? 'success' : (x.connectionStatus==='FAILED')? 'failed' : '';
          card.innerHTML=`
            <div class='card-header'>
              <div>
                <div class='title'>
                  <span class='name'>${x.serviceName||'(未命名)'} </span>
                  <span class='badge type'>${x.serviceType||''}</span>
                  <span class='badge ${statusClass}'>${x.connectionStatus||''}</span>
                </div>
                <div class='subtitle muted'>${x.baseUrl||''}</div>
              </div>
            </div>
          `;
          const t=(x.serviceType||'').toLowerCase();
          if(t) card.classList.add('t-'+t);
          card.style.cursor='pointer';
          card.onclick=(e)=>{
            const t=e.target.closest('.icon-btn');
            if(t) return; // 避免与操作按钮冲突
            location.href=`/admin/service.html?id=${x.id}`;
          };
          listEl.appendChild(card);
        });
        
        if(location.hash==='#custom-script') filterForCustom();
      });
    }
    load();
    function toast(t){const el=document.querySelector('#toast');el.textContent=t;el.classList.add('show');setTimeout(()=>el.classList.remove('show'),1600)}
    function filterForCustom(){
      document.querySelector('#scriptHelp').style.display='block';
      document.querySelectorAll('.svc').forEach(card=>{
        const type = card.dataset.type || '';
        card.style.display = (type!=='CUSTOM')? 'none' : '';
      });
    }
  </script>
</body>
</html>
