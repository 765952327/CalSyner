<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>操作日志</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="/admin/styles.css">
</head>
<body class="container">
  <div class="layout">
    <svg style="display:none" xmlns="http://www.w3.org/2000/svg">
      <symbol id="i-filter" viewBox="0 0 24 24"><path d="M3 5h18L14 13v6l-4-2v-4z" stroke="currentColor" stroke-width="2" fill="none"/></symbol>
      <symbol id="i-success" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="2" fill="none"/><path d="M7 12l3 3 7-7" stroke="currentColor" stroke-width="2" fill="none"/></symbol>
      <symbol id="i-failed" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="2" fill="none"/><path d="M8 8l8 8M16 8l-8 8" stroke="currentColor" stroke-width="2"/></symbol>
      <symbol id="i-skip" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="2" fill="none"/><path d="M8 8h8v8H8z" stroke="currentColor" stroke-width="2" fill="none"/></symbol>
    </svg>
    <aside class="sidebar">
      <div class="brand"><span>JiraSync</span></div>
      <nav class="side-nav">
        <a href="/admin/index.html" title="首页"><span class="side-icon"><svg viewBox="0 0 24 24"><path d="M3 10 L12 3 L21 10 V21 H3 Z" fill="currentColor"/></svg></span><span class="side-label">首页</span></a>
        <a href="/admin/config.html" title="服务配置"><span class="side-icon"><svg viewBox="0 0 24 24"><path d="M12 2 L19 7 L19 17 L12 22 L5 17 L5 7 Z" fill="currentColor"/></svg></span><span class="side-label">服务配置</span></a>
        <a href="/admin/tasks.html" title="同步任务"><span class="side-icon"><svg viewBox="0 0 24 24"><rect x="3" y="4" width="18" height="16" rx="2" ry="2" stroke="currentColor" stroke-width="2" fill="none"/><path d="M7 12 L10 15 L17 8" stroke="currentColor" stroke-width="2" fill="none"/></svg></span><span class="side-label">同步任务</span></a>
        <a href="/admin/records.html" title="同步记录"><span class="side-icon"><svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="9" stroke="currentColor" stroke-width="2" fill="none"/><path d="M12 7 L12 12 L16 14" stroke="currentColor" stroke-width="2"/></svg></span><span class="side-label">同步记录</span></a>
      </nav>
    </aside>
    <main>
  <header class="app"><h1>操作日志</h1></header>
  <div class="card">
    <label>摘要</label>
    <input id="fSummary" placeholder="包含...">
    <label>类型</label>
    <select id="fType">
      <option value="">全部</option>
      <option>CREATE_EVENT</option>
      <option>UPDATE_EVENT</option>
      <option>DELETE_EVENT</option>
      <option>CREATE_TODO</option>
      <option>UPDATE_TODO</option>
      <option>MANUAL_DELETE_EVENT</option>
    </select>
    <label>状态</label>
    <select id="fStatus">
      <option value="">全部</option>
      <option>SUCCESS</option>
      <option>FAILED</option>
      <option>SKIP</option>
    </select>
    <button class="btn icon-btn" title="筛选" id="btnFilter"><svg class="icon"><use href="#i-filter"/></svg></button>
  </div>
  <div class="card">
  <table id="tbl">
    <thead>
      <tr>
        <th>ID</th><th>类型</th><th>摘要</th><th>目标</th><th>状态</th><th>消息</th><th>任务ID</th><th>批次ID</th><th>时间</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
  </div>
  <script>
    const api='/api/ops';
    (function(){
      const p=location.pathname;
      const canon = (p.endsWith('/admin/logs.html')||p.endsWith('/admin/details.html'))? '/admin/records.html' : p;
      document.querySelectorAll('.side-nav a').forEach(a=>{ if(a.getAttribute('href')===canon) a.classList.add('active') });
    })();
    const pad=n=>n<10?'0'+n:n;
    const fmt=t=>{if(!t)return ''; const d=new Date(t); if(isNaN(d)) return ''; return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())} ${pad(d.getHours())}:${pad(d.getMinutes())}:${pad(d.getSeconds())}`};
    const tbody=document.querySelector('#tbl tbody');
    function load(){
      const q=new URLSearchParams();
      const s=document.querySelector('#fSummary').value.trim(); if(s) q.set('summary', s);
      const t=document.querySelector('#fType').value; if(t) q.set('opType', t);
      const st=document.querySelector('#fStatus').value; if(st) q.set('status', st);
      const params = new URLSearchParams(location.search);
      const recId = params.get('recordId');
      const url = recId ? (`/api/sync/records/${recId}/ops`) : (q.toString()? (api+'/search?'+q.toString()) : (api+'/logs'));
      fetch(url).then(r=>r.json()).then(list=>{
        tbody.innerHTML='';
        if(list.length===0){
          const tr=document.createElement('tr');
          tr.innerHTML=`<td colspan='9'><div class='empty'><svg class='icon'><use href='#i-filter'/></svg> 暂无日志</div></td>`;
          tbody.appendChild(tr);
          return;
        }
        list.forEach(x=>{
          const tr=document.createElement('tr');
          const cls = x.status==='SUCCESS'? 'icon-success' : (x.status==='FAILED'? 'icon-failed' : 'icon-running');
          const sIcon = x.status==='SUCCESS'? 'success' : (x.status==='FAILED'? 'failed' : 'skip');
          tr.innerHTML=`<td>${x.id}</td><td>${x.opType}</td><td>${x.summary||''}</td><td>${x.targetType||''}</td><td><span class='badge'><svg class='icon icon-sm ${cls}'><use href='#i-${sIcon}'/></svg> ${x.status}</span></td><td>${x.message||''}</td><td>${x.taskId||''}</td><td>${x.recordId||''}</td><td>${fmt(x.createdAt)||''}</td>`;
          tbody.appendChild(tr);
        });
      });
    }
    load();
    document.querySelector('#btnFilter').onclick=load;
  </script>
    </main>
  </div>
</body>
</html>
