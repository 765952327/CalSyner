<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>同步任务管理</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="/admin/styles.css">
</head>
<body class="container">
  <div class="layout">
    <svg style="display:none" xmlns="http://www.w3.org/2000/svg">
      <symbol id="i-edit" viewBox="0 0 24 24"><path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25z" fill="currentColor"/><path d="M20.71 7.04a1 1 0 0 0 0-1.41l-2.34-2.34a1 1 0 0 0-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z" fill="currentColor"/></symbol>
      <symbol id="i-save" viewBox="0 0 24 24"><path d="M17 3H5a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V7l-4-4z" stroke="currentColor" stroke-width="2" fill="none"/><path d="M17 3v5H7V3" stroke="currentColor" stroke-width="2"/><rect x="7" y="13" width="10" height="6" stroke="currentColor" stroke-width="2" fill="none"/></symbol>
      <symbol id="i-play" viewBox="0 0 24 24"><path d="M8 5v14l11-7z" fill="currentColor"/></symbol>
      <symbol id="i-power" viewBox="0 0 24 24"><path d="M12 2v10" stroke="currentColor" stroke-width="2"/><circle cx="12" cy="12" r="9" stroke="currentColor" stroke-width="2" fill="none"/></symbol>
      <symbol id="i-trash" viewBox="0 0 24 24"><path d="M3 6h18" stroke="currentColor" stroke-width="2"/><path d="M8 6V4h8v2" stroke="currentColor" stroke-width="2"/><rect x="5" y="6" width="14" height="14" rx="2" ry="2" stroke="currentColor" stroke-width="2" fill="none"/></symbol>
    </svg>
    <aside class="sidebar">
      <div class="brand"><span>JiraSync</span></div>
      <nav class="side-nav">
        <a href="/admin/index.html" title="首页"><span class="side-icon"><svg class="icon icon-sm" viewBox="0 0 24 24"><path d="M3 10 L12 3 L21 10 V21 H3 Z" fill="currentColor"/></svg></span><span class="side-label">首页</span></a>
        <a href="/admin/config.html" title="服务配置"><span class="side-icon"><svg class="icon icon-sm" viewBox="0 0 24 24"><path d="M12 2 L19 7 L19 17 L12 22 L5 17 L5 7 Z" fill="currentColor"/></svg></span><span class="side-label">服务配置</span></a>
        <a href="/admin/tasks.html" title="同步任务"><span class="side-icon"><svg class="icon icon-sm" viewBox="0 0 24 24"><rect x="3" y="4" width="18" height="16" rx="2" ry="2" stroke="currentColor" stroke-width="2" fill="none"/><path d="M7 12 L10 15 L17 8" stroke="currentColor" stroke-width="2" fill="none"/></svg></span><span class="side-label">同步任务</span></a>
        <a href="/admin/records.html" title="同步记录"><span class="side-icon"><svg class="icon icon-sm" viewBox="0 0 24 24"><circle cx="12" cy="12" r="9" stroke="currentColor" stroke-width="2" fill="none"/><path d="M12 7 L12 12 L16 14" stroke="currentColor" stroke-width="2"/></svg></span><span class="side-label">同步记录</span></a>
      </nav>
    </aside>
    <main>
  <header class="app"><h1>同步任务</h1></header>

  <div class="hero">
    <h3 class="title">同步任务</h3>
    <p class="desc">管理任务的调度、同步源与目标映射；支持一键执行与启停。</p>
  </div>
  <div class="section-card">
    <h3>现有任务</h3>
    <div class="card filter">
      <div class="toolbar filter-bar">
        <input id="fTaskName" placeholder="任务名称（支持模糊）">
        <div class="spacer"></div>
        <a class="btn" href="/admin/task-create.html" id="btnNewTask">新增任务</a>
      </div>
    </div>
  <table id="tbl">
    <thead>
      <tr>
        <th>ID</th><th>名称</th><th>启用</th><th>同步源</th><th>同步目标</th><th>Cron</th><th>JQL</th><th>描述</th><th>状态</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
  </div>

  
  <div id="toast" class="toast"></div>
    </main>
  </div>

  <script>
    const api='/api/sync/tasks';
    (function(){
      const p=location.pathname;
      const canon = (p.endsWith('/admin/logs.html')||p.endsWith('/admin/details.html'))? '/admin/records.html' : p;
      document.querySelectorAll('.side-nav a').forEach(a=>{ if(a.getAttribute('href')===canon) a.classList.add('active') });
    })();
    const tbody=document.querySelector('#tbl tbody');
    let jiraOptions=[]; let radicateOptions=[];
    function loadConfigs(){
      return fetch('/api/config/services').then(r=>r.json()).then(list=>{
        jiraOptions=list.filter(x=>x.serviceType==='JIRA');
        radicateOptions=list.filter(x=>x.serviceType==='RADICALE');
      });
    }
    function load(){
      Promise.all([loadConfigs(), fetch(api).then(r=>r.json())]).then(([_, list])=>{
        const qName=(document.querySelector('#fTaskName')?.value||'').trim();
        if(qName){ list=list.filter(x=>((x.taskName||'').indexOf(qName)>-1)); }
        tbody.innerHTML='';
        list.forEach(x=>{
          const tr=document.createElement('tr');
          const jName = (jiraOptions.find(o=>o.id===x.jiraConfigId)?.serviceName) || (x.jiraConfigId?('JIRA '+x.jiraConfigId):'-');
          const rName = (radicateOptions.find(o=>o.id===x.radicateConfigId)?.serviceName) || (x.radicateConfigId?('RADICALE '+x.radicateConfigId):'-');
          tr.innerHTML=`<td>${x.id}</td>
          <td>${x.taskName||'-'}</td>
          <td>${x.isEnabled?'true':'false'}</td>
          <td>${jName}</td>
          <td>${rName}</td>
          <td>${x.cronExpression||''}</td>
          <td>${x.jqlExpression||''}</td>
          <td>${x.description||''}</td>
          <td><span class='badge'>${x.syncStatus||''}</span></td>`;
          tr.style.cursor='pointer';
          tr.onclick=()=>{ location.href='/admin/task.html?id='+x.id; };
          tbody.appendChild(tr);
        });
      });
    }
    function toast(t){const el=document.querySelector('#toast');el.textContent=t;el.classList.add('show');setTimeout(()=>el.classList.remove('show'),1600)}
    document.querySelector('#fTaskName')?.addEventListener('input',()=>{ load(); });
    
    load();
    
  </script>
</body>
</html>
