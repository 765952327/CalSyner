<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>同步任务管理</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="/admin/styles.css">
</head>
<body class="container">
  <div class="layout">
    <svg style="display:none" xmlns="http://www.w3.org/2000/svg">
      <symbol id="i-edit" viewBox="0 0 24 24"><path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25z" fill="currentColor"/><path d="M20.71 7.04a1 1 0 0 0 0-1.41l-2.34-2.34a1 1 0 0 0-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z" fill="currentColor"/></symbol>
      <symbol id="i-save" viewBox="0 0 24 24"><path d="M17 3H5a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V7l-4-4z" stroke="currentColor" stroke-width="2" fill="none"/><path d="M17 3v5H7V3" stroke="currentColor" stroke-width="2"/><rect x="7" y="13" width="10" height="6" stroke="currentColor" stroke-width="2" fill="none"/></symbol>
      <symbol id="i-play" viewBox="0 0 24 24"><path d="M8 5v14l11-7z" fill="currentColor"/></symbol>
      <symbol id="i-power" viewBox="0 0 24 24"><path d="M12 2v10" stroke="currentColor" stroke-width="2"/><circle cx="12" cy="12" r="9" stroke="currentColor" stroke-width="2" fill="none"/></symbol>
      <symbol id="i-trash" viewBox="0 0 24 24"><path d="M3 6h18" stroke="currentColor" stroke-width="2"/><path d="M8 6V4h8v2" stroke="currentColor" stroke-width="2"/><rect x="5" y="6" width="14" height="14" rx="2" ry="2" stroke="currentColor" stroke-width="2" fill="none"/></symbol>
    </svg>
    <aside class="sidebar">
      <div class="brand"><span>JiraSync</span></div>
      <nav class="side-nav">
        <a href="/admin/index.html" title="首页"><span class="side-icon"><svg class="icon icon-sm" viewBox="0 0 24 24"><path d="M3 10 L12 3 L21 10 V21 H3 Z" fill="currentColor"/></svg></span><span class="side-label">首页</span></a>
        <a href="/admin/config.html" title="服务配置"><span class="side-icon"><svg class="icon icon-sm" viewBox="0 0 24 24"><path d="M12 2 L19 7 L19 17 L12 22 L5 17 L5 7 Z" fill="currentColor"/></svg></span><span class="side-label">服务配置</span></a>
        <a href="/admin/tasks.html" title="同步任务"><span class="side-icon"><svg class="icon icon-sm" viewBox="0 0 24 24"><rect x="3" y="4" width="18" height="16" rx="2" ry="2" stroke="currentColor" stroke-width="2" fill="none"/><path d="M7 12 L10 15 L17 8" stroke="currentColor" stroke-width="2" fill="none"/></svg></span><span class="side-label">同步任务</span></a>
        <a href="/admin/records.html" title="同步记录"><span class="side-icon"><svg class="icon icon-sm" viewBox="0 0 24 24"><circle cx="12" cy="12" r="9" stroke="currentColor" stroke-width="2" fill="none"/><path d="M12 7 L12 12 L16 14" stroke="currentColor" stroke-width="2"/></svg></span><span class="side-label">同步记录</span></a>
      </nav>
    </aside>
    <main>
  <header class="app"><h1>同步任务</h1></header>

  <h3>现有任务</h3>
  <div class="card">
  <table id="tbl">
    <thead>
      <tr>
        <th>ID</th><th>名称</th><th>启用</th><th>Cron</th><th>状态</th><th>操作</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
  </div>

  <h3>新增任务</h3>
  <div class="card">
  <div class="row">
    <div>
      <label>任务名称</label>
      <input id="taskName">
    </div>
    <div>
      <label>启用</label>
      <select id="isEnabled"><option value="true">true</option><option value="false">false</option></select>
    </div>
    <div>
      <label>Jira配置ID</label>
      <input id="jiraConfigId" placeholder="服务配置中的 JIRA ID">
    </div>
    <div>
      <label>Radicate配置ID</label>
      <input id="radicateConfigId" placeholder="服务配置中的 RADICATE ID">
    </div>
    <div>
      <label>Cron表达式</label>
      <input id="cronExpression" placeholder="0 0/10 * * * ?">
    </div>
    <div>
      <label>JQL表达式</label>
      <textarea id="jqlExpression" rows="4"></textarea>
    </div>
    <div style="grid-column:1/span 2">
      <label>描述</label>
      <textarea id="description" rows="3"></textarea>
    </div>
  </div>
  <p><button class="btn" id="btnCreate">保存</button></p>
  </div>
  <div id="toast" class="toast"></div>
    </main>
  </div>

  <script>
    const api='/api/sync/tasks';
    (function(){
      const p=location.pathname;
      const canon = (p.endsWith('/admin/logs.html')||p.endsWith('/admin/details.html'))? '/admin/records.html' : p;
      document.querySelectorAll('.side-nav a').forEach(a=>{ if(a.getAttribute('href')===canon) a.classList.add('active') });
    })();
    const tbody=document.querySelector('#tbl tbody');
    function load(){
      fetch(api).then(r=>r.json()).then(list=>{
        tbody.innerHTML='';
        list.forEach(x=>{
          const tr=document.createElement('tr');
          tr.innerHTML=`<td>${x.id}</td>
          <td><input data-k='taskName' value='${x.taskName||''}' disabled></td>
          <td><select data-k='isEnabled' disabled><option value='true' ${x.isEnabled?'selected':''}>true</option><option value='false' ${!x.isEnabled?'selected':''}>false</option></select></td>
          <td><input data-k='cronExpression' value='${x.cronExpression||''}' disabled></td>
          <td><span class='badge'>${x.syncStatus||''}</span></td>
          <td class='ops'>
            <button class='btn-outline icon-btn' title='编辑' data-act='edit' data-id='${x.id}'><svg class='icon icon-md'><use href='#i-edit'/></svg></button>
            <button class='btn-outline icon-btn' title='保存' data-act='save' data-id='${x.id}' disabled><svg class='icon icon-md'><use href='#i-save'/></svg></button>
            <button class='btn-outline icon-btn' title='执行' data-act='exec' data-id='${x.id}'><svg class='icon icon-md'><use href='#i-play'/></svg></button>
            <button class='btn-outline icon-btn' title='启停' data-act='toggle' data-id='${x.id}'><svg class='icon icon-md'><use href='#i-power'/></svg></button>
            <button class='btn-outline icon-btn btn-danger' title='删除' data-act='del' data-id='${x.id}'><svg class='icon icon-md'><use href='#i-trash'/></svg></button>
          </td>`;
          tbody.appendChild(tr);
        });
        bindOps();
      });
    }
    function toast(t){const el=document.querySelector('#toast');el.textContent=t;el.classList.add('show');setTimeout(()=>el.classList.remove('show'),1600)}
    function bindOps(){
      document.querySelectorAll('.btn-outline').forEach(b=>{
        b.onclick=(e)=>{
          e.preventDefault();
          const id=b.dataset.id;
          const act=b.dataset.act;
          const go=async()=>{
            try{
              if(act==='edit'){
                const tr=b.closest('tr'); tr.querySelectorAll('input,select').forEach(el=>el.disabled=false);
                tr.querySelector("[data-act='save']").disabled=false;
              }
              if(act==='save'){
                const tr=b.closest('tr');
                const get=k=>tr.querySelector(`[data-k='${k}']`).value;
                const body={taskName:get('taskName'),isEnabled:get('isEnabled')==='true',cronExpression:get('cronExpression')};
                await fetch(`${api}/${id}`,{method:'PUT',headers:{'Content-Type':'application/json'},body:JSON.stringify(body)});
                toast('已保存');
              }
              if(act==='exec'){await fetch(`${api}/${id}/execute`,{method:'POST'});toast('已触发执行');}
              if(act==='toggle'){await fetch(`${api}/${id}/toggle`,{method:'POST'});toast('已切换启用');}
              if(act==='del'){await fetch(`${api}/${id}`,{method:'DELETE'});toast('已删除');}
              load();
            }catch(err){
              alert('操作失败: '+err);
            }
          };
          go();
        };
      });
    }
    load();
    document.querySelector('#btnCreate').onclick=()=>{
      const body={
        taskName:document.querySelector('#taskName').value,
        isEnabled:document.querySelector('#isEnabled').value==='true',
        jiraConfigId:parseInt(document.querySelector('#jiraConfigId').value||'0'),
        radicateConfigId:parseInt(document.querySelector('#radicateConfigId').value||'0'),
        cronExpression:document.querySelector('#cronExpression').value,
        jqlExpression:document.querySelector('#jqlExpression').value,
        description:document.querySelector('#description').value
      };
      fetch(api,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(body)}).then(()=>load());
    };
  </script>
</body>
</html>
