<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>任务详情</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="/admin/styles.css">
</head>
<body class="container">
  <div class="layout">
    <aside class="sidebar">
      <div class="brand"><span>JiraSync</span></div>
      <nav class="side-nav">
        <a href="/admin/index.html" title="首页"><span class="side-icon"><svg class="icon icon-sm" viewBox="0 0 24 24"><path d="M3 10 L12 3 L21 10 V21 H3 Z" fill="currentColor"/></svg></span><span class="side-label">首页</span></a>
        <a href="/admin/config.html" title="服务配置"><span class="side-icon"><svg class="icon icon-sm" viewBox="0 0 24 24"><path d="M12 2 L19 7 L19 17 L12 22 L5 17 L5 7 Z" fill="currentColor"/></svg></span><span class="side-label">服务配置</span></a>
        <a href="/admin/tasks.html" title="同步任务" class="active"><span class="side-icon"><svg class="icon icon-sm" viewBox="0 0 24 24"><rect x="3" y="4" width="18" height="16" rx="2" ry="2" stroke="currentColor" stroke-width="2" fill="none"/><path d="M7 12 L10 15 L17 8" stroke="currentColor" stroke-width="2" fill="none"/></svg></span><span class="side-label">同步任务</span></a>
        <a href="/admin/records.html" title="同步记录"><span class="side-icon"><svg class="icon icon-sm" viewBox="0 0 24 24"><circle cx="12" cy="12" r="9" stroke="currentColor" stroke-width="2" fill="none"/><path d="M12 7 L12 12 L16 14" stroke="currentColor" stroke-width="2"/></svg></span><span class="side-label">同步记录</span></a>
      </nav>
    </aside>
    <main>
      <header class="app"><h1>任务详情</h1><nav class="app"><a href="/admin/tasks.html">返回列表</a></nav></header>
      <div class="hero">
        <h3 class="title"><span id="tName">-</span></h3>
        <p class="desc">状态：<span class="badge" id="tStatus">-</span>　启用：<span id="tEnabled">-</span></p>
        <div class="desc">
          <span class="badge type" id="tSrc">源：-</span>
          <span class="badge type" id="tDst">目标：-</span>
          <span class="badge type" id="tCron">Cron：-</span>
        </div>
        <div class="desc">
          <span class="muted">最近：<span id="tLastSync">-</span></span>
          <span class="muted">下次：<span id="tNextSync">-</span></span>
        </div>
      </div>

      <div class="grid cols-auto section">
        <div class="card kpi accent-info" id="cardLastStart">
          <div>
            <div class="label">最近开始时间</div>
            <div class="trend">该任务最近一次执行</div>
          </div>
          <div class="value" id="kLastStart">-</div>
        </div>
        <div class="card kpi accent-info" id="cardLastStatus">
          <div>
            <div class="label">最近状态</div>
            <div class="trend">SUCCESS / FAILED 等</div>
          </div>
          <div class="value" id="kLastStatusTask">-</div>
        </div>
        <div class="card kpi accent-info" id="cardLastCounts">
          <div>
            <div class="label">最近处理/失败</div>
            <div class="trend">processed / failed</div>
          </div>
          <div class="value" id="kLastCountsTask">-</div>
        </div>
        <div class="card kpi accent-info" id="cardSuccessRate">
          <div>
            <div class="label">成功率（近N次）</div>
            <div class="trend">SUCCESS / 总数</div>
          </div>
          <div class="value" id="kSuccessRate">-</div>
        </div>
        <div class="card kpi accent-info" id="cardAvgDuration">
          <div>
            <div class="label">平均耗时（秒）（近N次）</div>
            <div class="trend">有效记录平均值</div>
          </div>
          <div class="value" id="kAvgDuration">-</div>
        </div>
      </div>

      <div class="section-card tool">
        <div class="card-header">
          <div class="title"><svg class="icon icon-md" viewBox="0 0 24 24"><path d="M4 19H20" stroke="currentColor" stroke-width="2" fill="none"/><path d="M6 16V10" stroke="currentColor" stroke-width="2" fill="none"/><path d="M12 16V6" stroke="currentColor" stroke-width="2" fill="none"/><path d="M18 16V12" stroke="currentColor" stroke-width="2" fill="none"/></svg><span class="name">图表工具</span></div>
          <div class="toolbar" id="chartTools">
            <select id="chartWindow"><option value="12">近12次</option><option value="24">近24次</option><option value="50">近50次</option></select>
            <button class="icon-btn refresh-btn" id="btnRefreshCharts" title="刷新图表"><svg class="icon icon-md" viewBox="0 0 24 24"><path d="M12 5a7 7 0 1 1-6.9 8.2" stroke="currentColor" stroke-width="2" fill="none"/><path d="M12 5v4" stroke="currentColor" stroke-width="2"/><path d="M12 9h4" stroke="currentColor" stroke-width="2"/></svg></button>
          </div>
        </div>
      </div>
      <div class="charts section">
        <div class="chart">
          <h3>状态分布（该任务）</h3>
          <svg id="chartTaskStatus"></svg>
          <div class="legend">
            <div class="item"><span class="swatch sw-success"></span>SUCCESS</div>
            <div class="item"><span class="swatch sw-failed"></span>FAILED</div>
            <div class="item"><span class="swatch sw-partial"></span>PARTIAL</div>
            <div class="item"><span class="swatch sw-running"></span>RUNNING</div>
          </div>
        </div>
        <div class="chart">
          <h3>处理条数（近12次）</h3>
          <svg id="chartTaskTrend"></svg>
        </div>
        <div class="chart">
          <h3>耗时趋势（秒）（近12次）</h3>
          <svg id="chartTaskDuration"></svg>
        </div>
      </div>

      <div class="section-card">
        <h3>最近操作日志（最新记录前5条）</h3>
        <div class="row">
          <div class="form-item">
            <div id="opsPreview"></div>
            <div class="toolbar"><button class="btn-outline" id="btnViewAllDetails">查看全部数据详情</button><button class="btn-outline" id="btnViewAllOps">查看全部操作日志</button></div>
          </div>
        </div>
      </div>

      <div class="section-card">
        <h3>基础信息</h3>
        <div class="row">
          <div class="form-item"><label>任务名称</label><input id="taskName"></div>
        </div>
        <div class="row">
          <div class="form-item"><label>启用</label><select id="isEnabled"><option value="true">true</option><option value="false">false</option></select></div>
        </div>
        <div class="row">
          <div class="form-item"><label>同步源（JIRA）</label><select id="jiraConfigId"><option value="">未选择</option></select></div>
        </div>
        <div class="row">
          <div class="form-item"><label>同步目标（RADICALE）</label><select id="radicateConfigId"><option value="">未选择</option></select></div>
        </div>
      </div>

      <div class="section-card">
        <h3>调度与筛选</h3>
        <div class="row">
          <div class="form-item"><label>Cron表达式</label><input id="cronExpression" placeholder="0 0/10 * * * ?"><div class="help">需 6 或 7 段表达式</div></div>
        </div>
        <div class="row">
          <div class="form-item"><label>JQL表达式</label><textarea id="jqlExpression" rows="4"></textarea></div>
        </div>
      </div>

      <div class="section-card">
        <h3>字段映射</h3>
        <div class="row">
          <div class="form-item"><label>描述 / 字段映射(JSON)</label><textarea id="description" rows="6" placeholder='[{"jiraField":"summary","radicateField":"summary"}]'></textarea></div>
        </div>
        <div class="row">
          <div class="form-item">
            <div class="help">映射规则：以 JSON 数组表示，每项包含 <code>jiraField</code> 与 <code>radicateField</code>。<br>源字段可选：summary, description, location, start, end；目标字段可选：summary, description, location, start, end, url, organizer, externalId, rrule。</div>
            <div class="toolbar" id="mapTools">
              <span class="badge type jira" id="mapSrcSvc">源：-</span>
              <select id="mapSrc"></select>
              <span>→</span>
              <span class="badge type radicale" id="mapDstSvc">目标：-</span>
              <select id="mapDst"></select>
              <button class="btn" id="btnAddMap">添加映射</button>
            </div>
            <div class="card" id="mapPreview"></div>
          </div>
        </div>
        <div class="actions-bar">
          <button class="btn btn-lg" id="btnSave">保存</button>
          <button class="btn-outline btn-lg" id="btnExec">执行</button>
          <button class="btn-outline btn-lg" id="btnToggle">启停</button>
          <button class="btn-outline btn-lg btn-danger" id="btnDel">删除</button>
        </div>
      </div>

      <div id="toast" class="toast"></div>
    </main>
  </div>

  <script>
    const api='/api/sync/tasks';
    const id=parseInt(new URLSearchParams(location.search).get('id')||'0');
    function toast(t){const el=document.querySelector('#toast');el.textContent=t;el.classList.add('show');setTimeout(()=>el.classList.remove('show'),1600)}
    let jiraOptions=[]; let radicateOptions=[];
    const pad=n=>n<10?'0'+n:n;
    const fmt=t=>{if(!t)return ''; const d=new Date(t); if(isNaN(d)) return ''; return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())} ${pad(d.getHours())}:${pad(d.getMinutes())}:${pad(d.getSeconds())}`};
    function loadConfigs(){
      return fetch('/api/config/services').then(r=>r.json()).then(list=>{
        jiraOptions=list.filter(x=>x.serviceType==='JIRA');
        radicateOptions=list.filter(x=>x.serviceType==='RADICALE');
        const jSel=document.querySelector('#jiraConfigId');
        const rSel=document.querySelector('#radicateConfigId');
        jSel.innerHTML='<option value="">未选择</option>' + jiraOptions.map(x=>`<option value="${x.id}">${x.serviceName||('JIRA '+x.id)}</option>`).join('');
        rSel.innerHTML='<option value="">未选择</option>' + radicateOptions.map(x=>`<option value="${x.id}">${x.serviceName||('RADICALE '+x.id)}</option>`).join('');
      });
    }
    function fill(x){
      document.querySelector('#tName').textContent = x.taskName||('- 任务 '+x.id);
      const st = (x.syncStatus||'').toUpperCase();
      const stCls = st==='SUCCESS'? 'success' : st==='FAILED'? 'failed' : st==='PARTIAL'? 'partial' : st? 'running' : '';
      const stEl=document.querySelector('#tStatus');
      stEl.textContent = st || '';
      stEl.className = 'badge' + (stCls? (' '+stCls) : '');
      const hero=document.querySelector('.hero');
      hero.className = 'hero ' + (x.isEnabled? 'e-enabled' : 'e-disabled');
      document.querySelector('#tEnabled').textContent = x.isEnabled?'true':'false';
      const enEl=document.querySelector('#tEnabled');
      enEl.textContent = x.isEnabled? '启用' : '停用';
      enEl.className = 'badge ' + (x.isEnabled? 'enabled' : 'disabled');
      document.querySelector('#taskName').value = x.taskName||'';
      document.querySelector('#isEnabled').value = x.isEnabled?'true':'false';
      document.querySelector('#jiraConfigId').value = x.jiraConfigId||'';
      document.querySelector('#radicateConfigId').value = x.radicateConfigId||'';
      document.querySelector('#cronExpression').value = x.cronExpression||'';
      document.querySelector('#jqlExpression').value = x.jqlExpression||'';
      document.querySelector('#description').value = x.description||'';
      const jName = (jiraOptions.find(o=>o.id===x.jiraConfigId)||{}).serviceName || (x.jiraConfigId? ('JIRA '+x.jiraConfigId) : '-');
      const rName = (radicateOptions.find(o=>o.id===x.radicateConfigId)||{}).serviceName || (x.radicateConfigId? ('RADICALE '+x.radicateConfigId) : '-');
      const tSrc=document.querySelector('#tSrc'); const tDst=document.querySelector('#tDst');
      tSrc.textContent = '源：'+jName; tDst.textContent = '目标：'+rName;
      tSrc.className = 'badge type jira'; tDst.className = 'badge type radicale';
      const mSrc=document.querySelector('#mapSrcSvc'); const mDst=document.querySelector('#mapDstSvc');
      if(mSrc) mSrc.textContent = '源：'+jName;
      if(mDst) mDst.textContent = '目标：'+rName;
      document.querySelector('#tCron').textContent = 'Cron：'+(x.cronExpression||'-');
      document.querySelector('#tLastSync').textContent = fmt(x.lastSyncTime)||'-';
      document.querySelector('#tNextSync').textContent = fmt(x.nextSyncTime)||'-';
    }
    function setAccent(el, type){ el.className = 'card kpi accent-'+type; }
    function load(){
      Promise.all([loadConfigs(), fetch(`${api}/${id}`).then(r=>r.json())]).then(([_, x])=>{ fill(x); loadTaskStats(); bindChartTools(); initMappingUI(); bindMappingConfigChange(); });
    }
    load();
    document.querySelector('#btnSave').onclick=async()=>{
      const body={
        taskName:document.querySelector('#taskName').value,
        isEnabled:document.querySelector('#isEnabled').value==='true',
        jiraConfigId:parseInt(document.querySelector('#jiraConfigId').value||'0')||null,
        radicateConfigId:parseInt(document.querySelector('#radicateConfigId').value||'0')||null,
        cronExpression:document.querySelector('#cronExpression').value,
        jqlExpression:document.querySelector('#jqlExpression').value,
        description:document.querySelector('#description').value
      };
      const okCron = ((body.cronExpression||'').trim().split(/\s+/).length===6) || ((body.cronExpression||'').trim().split(/\s+/).length===7);
      if(!okCron){ toast('Cron表达式不合法'); return; }
      try{ const r=await fetch(`${api}/${id}`,{method:'PUT',headers:{'Content-Type':'application/json'},body:JSON.stringify(body)}); if(!r.ok){ toast('保存失败'); return; } toast('已保存'); }catch(e){ toast('保存失败'); }
    };
    document.querySelector('#btnExec').onclick=async()=>{ await fetch(`${api}/${id}/execute`,{method:'POST'}); toast('已触发执行'); };
    document.querySelector('#btnToggle').onclick=async()=>{ await fetch(`${api}/${id}/toggle`,{method:'POST'}); toast('已切换启用'); load(); };
    document.querySelector('#btnDel').onclick=async()=>{ await fetch(`${api}/${id}`,{method:'DELETE'}); toast('已删除'); setTimeout(()=>{ location.href='/admin/tasks.html'; }, 200); };

    async function loadTaskStats(){
      try{
        const records=await fetch('/api/sync/records').then(r=>r.json());
        const list=records.filter(r=>String(r.taskId)===String(id));
        cachedTaskRecords = list.slice();
        if(list.length===0){
          document.querySelector('#kLastStart').textContent='-';
          document.querySelector('#kLastStatusTask').textContent='-';
          document.querySelector('#kLastCountsTask').textContent='-';
          drawDonutTask({SUCCESS:0,FAILED:0,PARTIAL:0,RUNNING:0});
          drawBarsProcessed([]);
          drawLineDuration([]);
          document.querySelector('#opsPreview').innerHTML='<div class="empty">暂无日志</div>';
          document.querySelector('#kSuccessRate').textContent='-';
          document.querySelector('#kAvgDuration').textContent='-';
          return;
        }
        list.sort((a,b)=>new Date(b.startTime||0)-new Date(a.startTime||0));
        const last=list[0];
        document.querySelector('#kLastStart').textContent=fmt(last.startTime);
        document.querySelector('#kLastStatusTask').textContent=last.status||'-';
        const stType = (last.status==='SUCCESS')? 'success' : (last.status==='FAILED')? 'failed' : (last.status==='PARTIAL')? 'warning' : 'info';
        setAccent(document.querySelector('#cardLastStatus'), stType);
        document.querySelector('#kLastCountsTask').textContent=`${last.processedItems||0} / ${last.failedItems||0}`;
        const cts={SUCCESS:0,FAILED:0,PARTIAL:0,RUNNING:0};
        list.forEach(r=>{ if(r.status&&cts.hasOwnProperty(r.status)) cts[r.status]++; });
        drawDonutTask(cts);
        renderChartsWithWindow();
        await loadTaskOps(last.id);
        updateKPIsWithWindow();
      }catch(e){console.error(e)}
    }

    function drawDonutTask(cts){
      const svg=document.querySelector('#chartTaskStatus'); svg.innerHTML='';
      const w=svg.clientWidth||600,h=svg.clientHeight||220; const cx=w/2, cy=h/2; const r=80; const sw=30;
      const total = Object.values(cts).reduce((a,b)=>a+b,0) || 1;
      let acc=0;
      const mkArc=(start,end,cls)=>{
        const circle=document.createElementNS('http://www.w3.org/2000/svg','circle');
        circle.setAttribute('cx', String(cx)); circle.setAttribute('cy', String(cy)); circle.setAttribute('r', String(r));
        circle.setAttribute('class','donut-seg '+cls);
        circle.setAttribute('stroke-width', String(sw));
        const cLen=2*Math.PI*r; const segLen=(end-start)*cLen; const offset=cLen*start;
        circle.setAttribute('stroke-dasharray', `${segLen} ${cLen}`);
        circle.setAttribute('stroke-dashoffset', String(-offset));
        svg.appendChild(circle);
      };
      const order=['SUCCESS','FAILED','PARTIAL','RUNNING'];
      order.forEach(k=>{
        const v=cts[k]||0; const frac=v/total; const start=acc; const end=acc+frac; acc=end;
        const cls = 'donut-'+k.toLowerCase();
        mkArc(start,end,cls);
      });
      const hole=document.createElementNS('http://www.w3.org/2000/svg','circle');
      hole.setAttribute('cx', String(cx)); hole.setAttribute('cy', String(cy)); hole.setAttribute('r', String(r-sw/2-1)); hole.setAttribute('fill', '#fff');
      svg.appendChild(hole);
    }

    function drawBarsProcessed(list){
      const svg=document.querySelector('#chartTaskTrend'); svg.innerHTML='';
      const w=svg.clientWidth||600,h=svg.clientHeight||220; const margin=30;
      const data=list.slice().sort((a,b)=>new Date(a.startTime||0)-new Date(b.startTime||0)).slice(-chartN).map(r=>Number(r.processedItems||0));
      const max=Math.max(1,...data); const bw=Math.floor((w-2*margin)/Math.max(1,data.length)) - 6;
      const axis=document.createElementNS('http://www.w3.org/2000/svg','line');
      axis.setAttribute('x1', String(margin)); axis.setAttribute('y1', String(h-margin)); axis.setAttribute('x2', String(w-margin)); axis.setAttribute('y2', String(h-margin)); axis.setAttribute('class','axis');
      svg.appendChild(axis);
      data.forEach((v,i)=>{
        const bh = Math.floor((h-2*margin)*v/max);
        const rect=document.createElementNS('http://www.w3.org/2000/svg','rect');
        rect.setAttribute('x', String(margin + i*(bw+6)));
        rect.setAttribute('y', String(h-margin-bh));
        rect.setAttribute('width', String(bw));
        rect.setAttribute('height', String(bh));
        rect.setAttribute('fill', '#3B82F6');
        svg.appendChild(rect);
        const label=document.createElementNS('http://www.w3.org/2000/svg','text');
        const lx = margin + i*(bw+6) + bw/2;
        const ly = h - margin - bh - 4;
        label.setAttribute('x', String(lx));
        label.setAttribute('y', String(ly));
        label.setAttribute('text-anchor','middle');
        label.setAttribute('class','val');
        label.textContent=String(Math.round(v));
        svg.appendChild(label);
      });
    }

    function drawLineDuration(list){
      const svg=document.querySelector('#chartTaskDuration'); svg.innerHTML='';
      const w=svg.clientWidth||600,h=svg.clientHeight||220; const margin=30;
      const series=list.slice().sort((a,b)=>new Date(a.startTime||0)-new Date(b.startTime||0)).slice(-chartN).map(r=>{const s=new Date(r.startTime||0), e=new Date(r.endTime||0); if(isNaN(s)||isNaN(e)) return 0; return Math.max(0,(e-s)/1000);} );
      const n=Math.max(1, series.length);
      const max=Math.max(1,...series);
      const axis=document.createElementNS('http://www.w3.org/2000/svg','line');
      axis.setAttribute('x1', String(margin)); axis.setAttribute('y1', String(h-margin)); axis.setAttribute('x2', String(w-margin)); axis.setAttribute('y2', String(h-margin)); axis.setAttribute('class','axis');
      svg.appendChild(axis);
      const path=document.createElementNS('http://www.w3.org/2000/svg','path');
      const step=(w-2*margin)/(n-1||1);
      let d='';
      series.forEach((v,i)=>{
        const x=margin + i*step;
        const y=h-margin - ((h-2*margin)*v/max);
        d += (i===0? `M ${x} ${y}` : ` L ${x} ${y}`);
      });
      path.setAttribute('d', d||`M ${margin} ${h-margin} L ${w-margin} ${h-margin}`);
      path.setAttribute('class','line');
      svg.appendChild(path);
      series.forEach((v,i)=>{
        const x=margin + i*step;
        const y=h-margin - ((h-2*margin)*v/max);
        const dot=document.createElementNS('http://www.w3.org/2000/svg','circle');
        dot.setAttribute('cx', String(x)); dot.setAttribute('cy', String(y)); dot.setAttribute('r', '3'); dot.setAttribute('class','dot');
        svg.appendChild(dot);
        const label=document.createElementNS('http://www.w3.org/2000/svg','text');
        label.setAttribute('x', String(x)); label.setAttribute('y', String(y-6)); label.setAttribute('text-anchor','middle'); label.setAttribute('class','val'); label.textContent=String(Math.round(v));
        svg.appendChild(label);
      });
    }

    function updateKPIsWithWindow(){
      const list=cachedTaskRecords.slice().sort((a,b)=>new Date(b.startTime||0)-new Date(a.startTime||0)).slice(0, chartN);
      const total=list.length||0;
      const succ=list.filter(r=>r.status==='SUCCESS').length;
      const rate=total? Math.round((succ/total)*100) : 0;
      const durs=list.map(r=>{const s=new Date(r.startTime||0), e=new Date(r.endTime||0); if(isNaN(s)||isNaN(e)) return 0; return Math.max(0,(e-s)/1000);} ).filter(x=>x>0);
      const avg=durs.length? Math.round(durs.reduce((a,b)=>a+b,0)/durs.length) : 0;
      document.querySelector('#kSuccessRate').textContent = `${rate}%`;
      setAccent(document.querySelector('#cardSuccessRate'), rate>=90? 'success' : rate>=70? 'info' : rate>=40? 'warning' : 'failed');
      document.querySelector('#kAvgDuration').textContent = String(avg);
      setAccent(document.querySelector('#cardAvgDuration'), avg<=10? 'success' : avg<=30? 'info' : avg<=60? 'warning' : 'failed');
    }

    function renderChartsWithWindow(){
      const list=cachedTaskRecords.slice();
      drawBarsProcessed(list);
      drawLineDuration(list);
    }

    function bindChartTools(){
      const sel=document.querySelector('#chartWindow');
      const btn=document.querySelector('#btnRefreshCharts');
      sel.onchange=()=>{ chartN = parseInt(sel.value||'12')||12; renderChartsWithWindow(); updateKPIsWithWindow(); };
      btn.onclick=()=>{ btn.classList.add('spinning'); renderChartsWithWindow(); updateKPIsWithWindow(); setTimeout(()=>btn.classList.remove('spinning'), 600); };
    }

    let lastRecordIdForLinks = null;
    document.querySelector('#btnViewAllDetails').onclick=()=>{ if(lastRecordIdForLinks) window.open(`/admin/details.html?id=${lastRecordIdForLinks}`, '_blank'); };
    document.querySelector('#btnViewAllOps').onclick=()=>{ if(lastRecordIdForLinks) window.open(`/admin/logs.html?recordId=${lastRecordIdForLinks}`, '_blank'); };

    async function loadTaskOps(recordId){
      try{
        const list=await fetch(`/api/sync/records/${recordId}/ops`).then(r=>r.json());
        const top=list.slice(0,5);
        const box=document.querySelector('#opsPreview'); box.innerHTML='';
        if(top.length===0){ box.innerHTML='<div class="empty">暂无日志</div>'; return; }
        top.forEach(o=>{
          const item=document.createElement('div');
          const cls = o.status==='SUCCESS'? 'badge success' : o.status==='FAILED'? 'badge failed' : o.status==='PARTIAL'? 'badge partial' : 'badge running';
          const t = fmt(o.createdAt);
          item.innerHTML = `<div class='kpi'><div><div class='label'>${o.opType||'-'}</div><div class='trend'>${o.summary||''}</div></div><div><span class='${cls}'>${o.status||''}</span> <span class='muted'>${t}</span></div></div>`;
          box.appendChild(item);
        });
      }catch(e){console.error(e)}
    }

    function initMappingUI(){
      const sSel=document.querySelector('#mapSrc');
      const dSel=document.querySelector('#mapDst');
      const jId = parseInt(document.querySelector('#jiraConfigId').value||'0')||null;
      const rId = parseInt(document.querySelector('#radicateConfigId').value||'0')||null;
      Promise.all([
        fetch(`/api/sync/tasks/fields/source${jId?('?serviceId='+jId):''}`).then(r=>r.json()),
        fetch(`/api/sync/tasks/fields/target${rId?('?serviceId='+rId):''}`).then(r=>r.json())
      ]).then(([srcFields,dstFields])=>{
        sSel.innerHTML = (srcFields||[]).map(f=>`<option value="${f}">${f}</option>`).join('');
        dSel.innerHTML = (dstFields||[]).map(f=>`<option value="${f}">${f}</option>`).join('');
      }).catch(()=>{
        sSel.innerHTML = ['summary','description','location','start','end'].map(f=>`<option value="${f}">${f}</option>`).join('');
        dSel.innerHTML = ['summary','description','location','start','end','url','organizer','externalId','rrule'].map(f=>`<option value="${f}">${f}</option>`).join('');
      });
      function parseMappings(){
        const txt=(document.querySelector('#description').value||'').trim();
        if(!txt) return [];
        try{ const arr=JSON.parse(txt); if(Array.isArray(arr)) return arr.filter(x=>x&&x.jiraField&&x.radicateField); return []; }catch(e){ return []; }
      }
      function renderPreview(){
        const box=document.querySelector('#mapPreview');
        const arr=parseMappings();
        if(arr.length===0){ box.innerHTML = '<div class="empty">暂无映射</div>'; return; }
        box.innerHTML='';
        arr.forEach((m,i)=>{
          const item=document.createElement('div');
          item.className='kpi';
          item.innerHTML=`<div><div class='label'>${m.jiraField||'-'} → ${m.radicateField||'-'}</div><div class='trend'>${m.transformType||''}</div></div><div><button class='btn-outline' data-i='${i}'>移除</button></div>`;
          box.appendChild(item);
        });
        box.querySelectorAll('button[data-i]').forEach(b=>{
          b.onclick=()=>{
            const arr=parseMappings(); const idx=parseInt(b.dataset.i||'0'); arr.splice(idx,1);
            document.querySelector('#description').value = JSON.stringify(arr, null, 2);
            renderPreview();
          };
        });
      }
      document.querySelector('#btnAddMap').onclick=()=>{
        const arr=parseMappings();
        arr.push({jiraField:sSel.value, radicateField:dSel.value});
        document.querySelector('#description').value = JSON.stringify(arr, null, 2);
        renderPreview();
      };
      document.querySelector('#description').addEventListener('input', ()=>renderPreview());
      renderPreview();
    }

    function bindMappingConfigChange(){
      const jSel=document.querySelector('#jiraConfigId');
      const rSel=document.querySelector('#radicateConfigId');
      if(jSel) jSel.addEventListener('change', ()=>initMappingUI());
      if(rSel) rSel.addEventListener('change', ()=>initMappingUI());
    }
  </script>
</body>
</html>
