<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>新增配置</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="/admin/styles.css">
</head>
<body class="container">
  <div class="layout">
    <aside class="sidebar">
      <div class="brand"><span>JiraSync</span></div>
      <nav class="side-nav">
        <a href="/admin/index.html" title="首页"><span class="side-icon"><svg class="icon icon-sm" viewBox="0 0 24 24"><path d="M3 10 L12 3 L21 10 V21 H3 Z" fill="currentColor"/></svg></span><span class="side-label">首页</span></a>
        <a href="/admin/config.html" title="服务配置" class="active"><span class="side-icon"><svg class="icon icon-sm" viewBox="0 0 24 24"><path d="M12 2 L19 7 L19 17 L12 22 L5 17 L5 7 Z" fill="currentColor"/></svg></span><span class="side-label">服务配置</span></a>
        <a href="/admin/tasks.html" title="同步任务"><span class="side-icon"><svg class="icon icon-sm" viewBox="0 0 24 24"><rect x="3" y="4" width="18" height="16" rx="2" ry="2" stroke="currentColor" stroke-width="2" fill="none"/><path d="M7 12 L10 15 L17 8" stroke="currentColor" stroke-width="2" fill="none"/></svg></span><span class="side-label">同步任务</span></a>
        <a href="/admin/records.html" title="同步记录"><span class="side-icon"><svg class="icon icon-sm" viewBox="0 0 24 24"><circle cx="12" cy="12" r="9" stroke="currentColor" stroke-width="2" fill="none"/><path d="M12 7 L12 12 L16 14" stroke="currentColor" stroke-width="2"/></svg></span><span class="side-label">同步记录</span></a>
      </nav>
    </aside>
    <main>
      <header class="app"><h1>新增配置</h1><nav class="app"><a href="/admin/config.html">返回列表</a></nav></header>
      <div class="hero t-radicale">
        <h3 class="title"><span class="type-icon"><svg class="icon-lg"><use id="typeIconUse" href="#i-radicale"/></svg></span><span>创建新服务</span></h3>
        <p class="desc">填写基础信息并保存，稍后可在详情页进行操作</p>
      </div>

      <div class="section-card">
        <h3>基本信息</h3>
        <div class="row">
          <div class="form-item">
            <label>类型</label>
            <select id="serviceType">
              <option value="RADICALE">RADICALE</option>
              <option value="JIRA">JIRA</option>
              <option value="CUSTOM">CUSTOM</option>
            </select>
          </div>
        </div>
        <div class="row">
          <div class="form-item">
            <label>名称</label>
            <input id="serviceName" placeholder="例如 Radicale-Prod">
          </div>
        </div>
      </div>

      <div class="section-card">
        <h3>连接信息</h3>
        <div class="row">
          <div class="form-item">
            <label>地址</label>
            <input id="baseUrl" placeholder="https://example.com/api">
            <div class="help">例如：https://example.com/api</div>
          </div>
        </div>
        <div class="row">
          <div class="form-item">
            <label>用户名</label>
            <input id="username">
          </div>
        </div>
        <div class="row">
          <div class="form-item">
            <label>密码</label>
            <input id="password" type="password">
          </div>
        </div>
      </div>

      <div class="section-card">
        <h3>高级</h3>
        <div class="row">
          <div class="form-item">
            <label>API Token</label>
            <input id="apiToken">
            <div class="help">用于 API 访问或存储脚本（仅 CUSTOM）</div>
          </div>
        </div>
        <div class="actions-bar">
          <button class="btn btn-lg" id="btnCreate">保存</button>
          <a class="btn-outline btn-lg" href="/admin/config.html">取消</a>
        </div>
      </div>

      <div class="section-card" id="scriptSection">
        <h3>脚本管理</h3>
        <div class="row">
          <div class="form-item">
            <label>自定义脚本（仅 CUSTOM 类型可用）</label>
            <div class="help">创建后可直接上传脚本并跳转到详情页</div>
          </div>
        </div>
        <div class="row">
          <div class="form-item">
            <label>脚本源码</label>
            <textarea id="scriptCode" rows="10" placeholder="粘贴自定义Java脚本源码（类名需为 CustomUserScript）"></textarea>
          </div>
        </div>
        <div class="actions-bar">
          <button class="btn-outline btn-lg" id="btnCreateAndScript">保存并上传脚本</button>
        </div>
      </div>

      <div id="toast" class="toast"></div>
    </main>
  </div>

  <svg style="display:none" xmlns="http://www.w3.org/2000/svg">
    <symbol id="i-radicale" viewBox="0 0 24 24"><rect x="3" y="4" width="18" height="16" rx="2" ry="2" stroke="currentColor" stroke-width="2" fill="none"/><path d="M3 8h18" stroke="currentColor" stroke-width="2"/></symbol>
    <symbol id="i-jira" viewBox="0 0 24 24"><path d="M12 2 L20 10 L12 22 L4 10 Z" fill="currentColor"/></symbol>
    <symbol id="i-custom" viewBox="0 0 24 24"><path d="M7 8 L3 12 L7 16" stroke="currentColor" stroke-width="2" fill="none"/><path d="M17 8 L21 12 L17 16" stroke="currentColor" stroke-width="2" fill="none"/><path d="M10 7 L14 17" stroke="currentColor" stroke-width="2"/></symbol>
  </svg>

  <script>
    const api = '/api/config/services';
    function toast(t){const el=document.querySelector('#toast');el.textContent=t;el.classList.add('show');setTimeout(()=>el.classList.remove('show'),1600)}
    function updateHero(type){
      const hero=document.querySelector('.hero');
      hero.classList.remove('t-radicale','t-jira','t-custom');
      const use=document.querySelector('#typeIconUse');
      if(type==='RADICALE'){ hero.classList.add('t-radicale'); use.setAttribute('href','#i-radicale'); }
      else if(type==='JIRA'){ hero.classList.add('t-jira'); use.setAttribute('href','#i-jira'); }
      else if(type==='CUSTOM'){ hero.classList.add('t-custom'); use.setAttribute('href','#i-custom'); }
    }
    function updateScriptUI(){
      const isCustom = document.querySelector('#serviceType').value === 'CUSTOM';
      document.querySelector('#btnCreateAndScript').disabled = !isCustom;
      const sec = document.querySelector('#scriptSection');
      if(sec) sec.style.display = isCustom ? '' : 'none';
    }
    document.querySelector('#serviceType').onchange=(e)=>{ updateHero(e.target.value); updateScriptUI(); };
    updateScriptUI();
    document.querySelector('#btnCreate').onclick=async ()=>{
      const body={
        serviceType:document.querySelector('#serviceType').value,
        serviceName:document.querySelector('#serviceName').value,
        baseUrl:document.querySelector('#baseUrl').value,
        username:document.querySelector('#username').value,
        password:document.querySelector('#password').value,
        apiToken:document.querySelector('#apiToken').value
      };
      try{
        const r = await fetch(api,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(body), keepalive:true});
        if(!r.ok){ toast('保存失败'); return; }
        await r.text().catch(()=>{});
        toast('已保存');
        setTimeout(()=>{ location.href='/admin/config.html'; }, 120);
      }catch(e){
        toast('保存失败');
      }
    };
    document.querySelector('#btnCreateAndScript').onclick=async ()=>{
      if(document.querySelector('#btnCreateAndScript').disabled) return;
      const body={
        serviceType:document.querySelector('#serviceType').value,
        serviceName:document.querySelector('#serviceName').value,
        baseUrl:document.querySelector('#baseUrl').value,
        username:document.querySelector('#username').value,
        password:document.querySelector('#password').value,
        apiToken:document.querySelector('#apiToken').value
      };
      try{
        const r = await fetch(api,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(body), keepalive:true});
        if(!r.ok){ toast('保存失败'); return; }
        const x = await r.json();
        const code = (document.querySelector('#scriptCode').value||'').trim();
        if(!code){ toast('已保存'); setTimeout(()=>{ location.href='/admin/service.html?id='+x.id; }, 120); return; }
        const r2 = await fetch(`${api}/${x.id}/script`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({code}), keepalive:true});
        if(!r2.ok){ toast('脚本上传失败'); setTimeout(()=>{ location.href='/admin/service.html?id='+x.id; }, 120); return; }
        await r2.text().catch(()=>{});
        toast('脚本已上传');
        setTimeout(()=>{ location.href='/admin/service.html?id='+x.id; }, 120);
      }catch(e){
        toast('保存失败');
      }
    };
  </script>
</body>
</html>
